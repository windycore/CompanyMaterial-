/******************************************************************************\

          (c) Copyright Explore Semiconductor, Inc. Limited 2005
                           ALL RIGHTS RESERVED 

--------------------------------------------------------------------------------

  File        :  Edid.c 

  Description :  Implement the interfaces fo Edid

  2007.06.06  :  1) Enhance for fault tolerance

\******************************************************************************/
#include "si_datatypes.h"
#include "InputHandle.h"
#include "sii_api.h"
#include "Edid.h"
#include "stdio.h"
#include "stdlib.h"

BYTE Sys_Ram[128];

//--------------------------------------------------------------------------------------------------

 BYTE EDID2B_Detailed_Timing_Descritpor_Table[][EDID2B_DETAILED_TIMING_DESCRITPOR_SIZE] = {
	{ 	// video code 0 (0 x 0, p, 0:0)
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	},{	// video code 1 (640 x 480 p, 4:3) ok
		0xD6, 0x09, 0x80, 0xA0, 0x20, 0xE0, 0x2D, 0x10, 0x10, 0x60, 0xA2, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x18,
	},{	// video code 2 (720 x 480 p, 4:3) ok
		0x8C, 0x0A, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10, 0x10, 0x3E, 0x96, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x18,
	},{	// video code 3 ( 720 x 480 p, 16:9) ok
		0x8C, 0x0A, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10,	0x10, 0x3E, 0x96, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 4 (1280 x 720 p, 16:9) ok
		0x01, 0x1D, 0x00, 0x72, 0x51, 0xD0, 0x1E, 0x20,	0x6E, 0x28, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{	// video code 5 (1920 x 1080 i, 16:9) ok
		0x01, 0x1D, 0x80, 0x18, 0x71, 0x1C, 0x16, 0x20, 0x58, 0x2C, 0x25, 0x00, 0x10, 0x09, 0x00, 0x00, 0x00, 0x9E,
	},{	// video code 6 (720(1440) x 480 i, 4:3) ok
		0x8C, 0x0A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 7 (720(1440) x 480 i, 16:9) ok
		0x8C, 0x0A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 8 (720(1440) x 240 p, 4:3) ok
		0x8C, 0x0A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x18,
	},{ // video code 9 (720(1440) x 240 p, 16:9) ok
		0x8C, 0x0A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 10 (2880 x 480 i, 4:3) ok
		0x18, 0x15, 0x40, 0x28, 0xB2, 0xF0, 0x16, 0x00,	0x4C, 0xF8, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x98,
	},{ // video code 11 (2880 x 480 i, 16:9) ok
		0x18, 0x15, 0x40, 0x28, 0xB2, 0xF0, 0x16, 0x00,	0x4C, 0xF8, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 12 (2880 x 240 p, 4:3) ok
		0x18, 0x15, 0x40, 0x28, 0xB2, 0xF0, 0x16, 0x00,	0x4C, 0xF8, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 13 (2880 x 240 p, 16:9) ok
		0x18, 0x15, 0x40, 0x28, 0xB2, 0xF0, 0x16, 0x00,	0x4C, 0xF8, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 14 (1440 x 480 p, 4:3) ok
		0x18, 0x15, 0xA0, 0x14, 0x51, 0xE0, 0x2D, 0x10,	0x20, 0x7C, 0x96, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 15 (1440 x 480 p, 16:9) ok
		0x18, 0x15, 0xA0, 0x14, 0x51, 0xE0, 0x2D, 0x10,	0x20, 0x7C, 0x96, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18, 
	},{	// video code 16(1920 x 1080 p, 16:9) ok
		0x02, 0x3A, 0x80, 0x18, 0x71, 0x38, 0x2D, 0x40,	0x58, 0x2C, 0x45, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 17 (720 x 576 p, 4:3) ok
		0x8C, 0x0A, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 18 (720 x 576 p, 16:9) ok
		0x8C, 0x0A, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 19 (1280 x 720 p, 16:9, 50Hz) ok
		0x01, 0x1D, 0x00, 0xBC, 0x52, 0xD0, 0x1E, 0x20,	0xB8, 0x28, 0x55, 0x40, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 20 (1920 x 1080 i, 16:9, 50Hz) ok
		0x01, 0x1D, 0x80, 0xD0, 0x72, 0x1C, 0x16, 0x20,	0x10, 0x2C, 0x25, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x9E,
	},{ // video code 21 (1440 x 576 i, 4:3, 50Hz) ok
		0x8C, 0x0A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 22 (1440 x 576 i, 16:9, 50Hz) ok
		0x8C, 0x0A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 23 (1440 x 288 p, 4:3, 50Hz) ok
		0x8C, 0x0A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 24 (1440 x 288 p, 16:9, 50Hz) ok
		0x8C, 0x0A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 25 (2880 x 576 i, 4:3, 50Hz) ok
		0x18, 0x15, 0x40, 0x40, 0xB2, 0x20, 0x18, 0x10,	0x30, 0xFC, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 26 (2880 x 576 i, 16:9, 50Hz) ok
		0x18, 0x15, 0x40, 0x40, 0xB2, 0x20, 0x18, 0x10,	0x30, 0xFC, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{ // video code 27 (2880 x 288 p, 4:3, 50Hz) ok
		0x18, 0x15, 0x40, 0x40, 0xB2, 0x20, 0x18, 0x10,	0x30, 0xFC, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 28 (2880 x 288 p, 16:9, 50Hz) ok
		0x18, 0x15, 0x40, 0x40, 0xB2, 0x20, 0x18, 0x10,	0x30, 0xFC, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{ // video code 29 (1440 x 576 p, 4:3, 50Hz) ok
		0x18, 0x15, 0xA0, 0x20, 0x51, 0x40, 0x31, 0x20,	0x18, 0x80, 0x55, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 30 (1440 x 576 p, 16:9, 50Hz) ok
		0x18, 0x15, 0xA0, 0x20, 0x51, 0x40, 0x31, 0x20,	0x18, 0x80, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 31 (1920 x 1080 p, 16:9, 50Hz) ok
		0x02, 0x3A, 0x80, 0xD0, 0x72, 0x38, 0x2D, 0x40,	0x10, 0x2C, 0x45, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 32 (1920 x 1080 p, 16:9, 24Hz) ok
		0x01, 0x1D, 0x80, 0x3E, 0x73, 0x38, 0x2D, 0x40,	0x7E, 0x2C, 0x45, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 33 (1920 x 1080 p, 16:9, 25Hz) ok
		0x01, 0x1D, 0x80, 0xD0, 0x72, 0x38, 0x2D, 0x40,	0x10, 0x2C, 0x45, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{ // video code 34 (1920 x 1080 p, 16:9, 30Hz) ok
		0x01, 0x1D, 0x80, 0xD0, 0x72, 0x38, 0x2D, 0x40,	0x10, 0x2C, 0x45, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{	// video code 35 (2880 x 480 p, 4:3, 60Hz) ok
		0x3B, 0x2A, 0x40, 0x28, 0xB2, 0xE0, 0x2D, 0x10,	0x60, 0xF8, 0x96, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x18,
	},{	// video code 36 (2880 x 480 p, 16:9, 60Hz) ok
		0x3B, 0x2A, 0x40, 0x28, 0xB2, 0xE0, 0x2D, 0x10,	0x60, 0xF8, 0x96, 0x00, 0x10, 0x09, 0x00, 0x00, 0x00, 0x18,
	},{	// video code 37 (2880 x 576 p, 4:3, 50Hz) ok
		0x30, 0x2A, 0x40, 0x40, 0xB2, 0x40, 0x31, 0x20,	0x30, 0x00, 0x55, 0x10, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 38 (2880 x 576 p, 16:9, 50Hz) ok
		0x30, 0x2A, 0x40, 0x40, 0xB2, 0x40, 0x31, 0x20,	0x30, 0x00, 0x55, 0x10, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 39 (1920 x 1080 i, 16:9, 50Hz) ok
		0x20, 0x1C, 0x80, 0x80, 0x71, 0x1C, 0x55, 0x20,	0x20, 0xA8, 0x75, 0x04, 0x10, 0x09, 0x00, 0x00,	0x00, 0x9A,
	},{	// video code 40 (1920 x 1080 i, 16:9, 100Hz) ok
		0x02, 0x3A, 0x80, 0xD0, 0x72, 0x1C, 0x16, 0x20,	0x10, 0x2C, 0x25, 0x80, 0x10, 0x09, 0x00, 0x00,	0x00, 0x9E,
	},{	// video code 41 (1280 x 720 p, 16:9, 100Hz) ok
		0x02, 0x3A, 0x00, 0xBC, 0x52, 0xD0, 0x1E, 0x20,	0xB8, 0x28, 0x55, 0x40, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{	// video code 42 (720 x 576 p, 4:3, 100Hz) ok
		0x18, 0x15, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 43 (720 x 576 p, 16:9, 100Hz) ok
		0x18, 0x15, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 44 (720(1440) x 576 i, 4:3, 100Hz) ok
		0x18, 0x15, 0xD0, 0x90, 0x20, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 45 (720(1440) x 576 i, 16:9, 100Hz) ok
		0x18, 0x15, 0xD0, 0x90, 0x20, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 46 (1920 x 1080 i, 16:9, 119.88/120Hz) ok
		0x02, 0x3A, 0x80, 0x18, 0x71, 0x1C, 0x16, 0x20,	0x58, 0x2C, 0x25, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x9E,
	},{	// video code 47 (1280 x 720 p, 16:9, 119.88/120Hz) ok
		0x02, 0x3A, 0x00, 0x72, 0x51, 0xD0, 0x1E, 0x20,	0x6E, 0x28, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x1E,
	},{	// video code 48 (720 x 480 p, 4:3, 119.88/120Hz) ok
		0x1D, 0x15, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10,	0x10, 0x3E, 0x96, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 49 (720 x 480 p, 16:9, 119.88/120Hz) ok
		0x1D, 0x15, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10,	0x10, 0x3E, 0x96, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 50 (720(1440) x 480 i, 4:3, 119.88/120Hz) ok
		0x1D, 0x15, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 51 (720(1440) x 480 i, 16:9, 119.88/120Hz) ok
		0x1D, 0x15, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 52 (720 x 576 p, 4:3, 200Hz) ok
		0x30, 0x2A, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 53 (720 x 576 p, 16:9, 200Hz) ok
		0x30, 0x2A, 0xD0, 0x90, 0x20, 0x40, 0x31, 0x20,	0x0C, 0x40, 0x55, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 54 (720(1440) x 576 i, 4:3, 200Hz) ok
		0x30, 0x2A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 55 (720(1440) x 576 i, 16:9, 200Hz) ok
		0x30, 0x2A, 0xA0, 0x20, 0x51, 0x20, 0x18, 0x10,	0x18, 0x7E, 0x23, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 56 (720 x 480 p, 4:3, 239.76/240Hz) ok
		0x3B, 0x2A, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10,	0x10, 0x3E, 0x96, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 57 (720 x 480 p, 16:9, 239.76/240Hz) ok
		0x3B, 0x2A, 0xD0, 0x8A, 0x20, 0xE0, 0x2D, 0x10,	0x10, 0x3E, 0x96, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x18,
	},{	// video code 58 (720(1440) x 480 i, 4:3, 239.76/240Hz) ok
		0x3B, 0x2A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x04, 0x03, 0x00, 0x00,	0x00, 0x98,
	},{	// video code 59 (720(1440) x 480 i, 16:9, 239.76/240Hz) ok
		0x3B, 0x2A, 0xA0, 0x14, 0x51, 0xF0, 0x16, 0x00,	0x26, 0x7C, 0x43, 0x00, 0x10, 0x09, 0x00, 0x00,	0x00, 0x98,
	},
};




 BYTE EDID2B_Basic_Audio_Desc[] = {
 0x09, 0x07, 0x07, // LPCM 2ch // 192KHz_176KHz_96KHz_88KHz_48KHz_44KHz_32KHz (0000_0111) // 24 bits_20 bits_16 bits (0000_0111)
};
	
 BYTE EDID2B_Basic_Speaker_Desc[] = {
 0x01, 0x00, 0x00, // 2 ch
};
	

 BYTE EDID2B_Advance_Speaker_Desc[] = {
// 0x0F, 0x00, 0x00, // 5.1 ch
// 0x1F, 0x00, 0x00, // 6.1 ch
 0x4F, 0x00, 0x00, // 7.1 ch
};

void SetBasicAudio(BYTE *AudioDesc, BYTE *AudioDescSize, BYTE *SpeakerDesc)
{
	// Audio Descriptor
	memcpy(AudioDesc, EDID2B_Basic_Audio_Desc, sizeof(EDID2B_Basic_Audio_Desc));
	*AudioDescSize = sizeof(EDID2B_Basic_Audio_Desc);
	
	// Use default Speaker Allocation Data Block
	memcpy(SpeakerDesc, EDID2B_Basic_Speaker_Desc, sizeof(EDID2B_Basic_Speaker_Desc));
}

void EDID_BypassWithAudio(ePOWER_STATUS POWER_STATUS, PEDIDB pCurrent)
{
	BYTE ChkSum=0;
	BYTE EDID_data_temp[256];
	BYTE m=0;
	EDIDB SinkEDID;
	BYTE Changed = 0,i;
	BYTE IndexT, IndexC, EndT, EndC, VideoCode;
	BYTE VideoFormat=0, VideoDescSize=0, AudioDescSize=0, VendorDescSize=0, xvDescSize=0, VidCapDescSize=0, VFPDBSize=0, Y420VDBSize=0, Y420CMDBSize=0;
	BYTE ScrAudioSize;
//	BYTE VideoDesc[EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE];
	BYTE *VideoDesc = Sys_Ram;
//	BYTE AudioDesc[EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE];
	BYTE *AudioDesc = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE;
//	BYTE SpeakerDesc[EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE];
	BYTE *SpeakerDesc = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE;
//	BYTE VendorDesc[EDID2B_TOTAL_VENDORDESC_DESC_SIZE];
	BYTE *VendorDesc = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE;

	// For Extended Block, not include the tag code
//	BYTE xvDesc[EDID2B_TOTAL_XVYCC_DESC_SIZE];
	BYTE *xvDesc = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE + EDID2B_TOTAL_VENDORDESC_DESC_SIZE;
//	BYTE VidCapDesc[EDID2B_TOTAL_VIDEO_CAP_DESC_SIZE];
	BYTE *VidCapDesc = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE + EDID2B_TOTAL_VENDORDESC_DESC_SIZE + EDID2B_TOTAL_XVYCC_DESC_SIZE;

//	BYTE VFPDB[EDID2B_TOTAL_VIDEO_PREFERENCE_SIZE];
	BYTE *VFPDB = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE + EDID2B_TOTAL_VENDORDESC_DESC_SIZE + EDID2B_TOTAL_XVYCC_DESC_SIZE + EDID2B_TOTAL_VIDEO_CAP_DESC_SIZE;
//	BYTE Y420VDB[EDID2B_TOTAL_420_VIDEO_BLOCK_SIZE];
	BYTE *Y420VDB = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE + EDID2B_TOTAL_VENDORDESC_DESC_SIZE + EDID2B_TOTAL_XVYCC_DESC_SIZE + EDID2B_TOTAL_VIDEO_CAP_DESC_SIZE + EDID2B_TOTAL_VIDEO_PREFERENCE_SIZE;
//	BYTE Y420CMDB[EDID2B_TOTAL_420_CAP_MAP_BLOCK_SIZE];
	BYTE *Y420CMDB = Sys_Ram + EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE + EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE + EDID2B_TOTAL_SHORT_SPEAKER_DESC_SIZE + EDID2B_TOTAL_VENDORDESC_DESC_SIZE + EDID2B_TOTAL_XVYCC_DESC_SIZE + EDID2B_TOTAL_VIDEO_CAP_DESC_SIZE + EDID2B_TOTAL_VIDEO_PREFERENCE_SIZE + EDID2B_TOTAL_420_VIDEO_BLOCK_SIZE;


       get_EDID(POWER_STATUS, (PBYTE)SinkEDID.Blocks);	
     
	IndexC = 132;				// Get Audio Data Block
	AudioDescSize=0;
	while(IndexC = EDID_GetDataBlockAddr((PBYTE)SinkEDID.Blocks, 0x20, IndexC)) {				//找到音频的启示位置

		// Audio Code Tag
		EndC = (SinkEDID.Blocks[0][IndexC] & 0x1F) + IndexC;
		++IndexC;

		// Audio Descriptor
		for(; IndexC <= EndC; IndexC++) {
			if(AudioDescSize < EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE) {
				AudioDesc[AudioDescSize++] = SinkEDID.Blocks[0][IndexC]; 							 //获取显示器的音频数据
			}
		}
	}
	
/***********************************获取源数据的音频长度*******************************************************************/
// Video********************8
	// Get Video Data Block
		IndexC = 132;
		VideoDescSize=0;
		while(IndexC = EDID_GetDataBlockAddr((PBYTE)pCurrent->Blocks, 0x40, IndexC)) {
	
			// Video Code Tag
			EndC = (pCurrent->Blocks[0][IndexC] & 0x1F) + IndexC;
			++IndexC;

			// Short Video Descriptor
			for(; IndexC <= EndC; IndexC++) {
				if(VideoDescSize < EDID2B_TOTAL_SHORT_VIDEO_DESC_SIZE) {
					VideoDesc[VideoDescSize++] = pCurrent->Blocks[0][IndexC];
				}
			}
			IndexT = IndexC;
		}

		IndexC = IndexT ;

// Audio Data Block******************
		if (IndexC > 132) //找到音频设置
              {
			ScrAudioSize=0;
			while(IndexC = EDID_GetDataBlockAddr((PBYTE)pCurrent->Blocks, 0x20, IndexC)) {//找到音频的启示位置

				// Audio Code Tag
				EndC = (pCurrent->Blocks[0][IndexC] & 0x1F) + IndexC;
				++IndexC;

				// Audio Descriptor
				for(; IndexC <= EndC; IndexC++) {
					if(ScrAudioSize < EDID2B_TOTAL_SHORT_AUDIO_DESC_SIZE) {
						ScrAudioSize++; 				//获取显示器的音频数据
					}
				}
				IndexT = IndexC;
			}

			IndexC = IndexT ;

			if(ScrAudioSize==AudioDescSize)
			{
				for(i=0; i<AudioDescSize; ++i) 
				{
					pCurrent->Blocks[0][IndexC-ScrAudioSize+i] = AudioDesc[i];
				}
			}
			else if(ScrAudioSize<AudioDescSize)
			{
				pCurrent->Blocks[0][130] += (AudioDescSize - ScrAudioSize); 						//视频描述的偏移地址需要变动
				m = IndexC-ScrAudioSize-1; 													//Audio Data Block 起始下标
				pCurrent->Blocks[0][m]	= (pCurrent->Blocks[0][m]&0xE0) | AudioDescSize;		//Audio Code Tag  的长度要更改
				
                            for (i = IndexC; i < 255; i++)
                            {
					EDID_data_temp[i-IndexC] = pCurrent->Blocks[0][i];				//保存音频数据块后面的数据
                            }

				for(i=0; i<AudioDescSize; i++) 
				{
					pCurrent->Blocks[0][IndexC-ScrAudioSize+i] = AudioDesc[i];	//用显示器的音频数据块替换原来EDID数据中的音频数据块
				}

				for(i=(m+AudioDescSize+1); i<255; i++) 
				{
					pCurrent->Blocks[0][i] = EDID_data_temp[i-(m+AudioDescSize+1)];	//恢复保存的音频数据块后面的数据
				}
			}
			else if(ScrAudioSize>AudioDescSize)			//输出口接的是DVI的edid
			{
				pCurrent->Blocks[0][126]=0;
				for(i=0; i<128; i++) 
					pCurrent->Blocks[1][i]=0xff;			//最后一块变成全0xff
			}
				
		}
		
		// Check Sum
		//
		// Block 0
		ChkSum = 0;
		for(i=0; i<127; ++i) 
		{
			ChkSum += pCurrent->Blocks[0][i];
		}
		pCurrent->Blocks[0][127] = ~(ChkSum - 1);

		// If we have Block 1
		if(pCurrent->Blocks[0][126] == 0x01) 
		{
			pCurrent->Blocks[1][126] = 0x00;	// We can not have block2
		
			ChkSum = 0;
			for(i=0; i<127; ++i) 
			{
				ChkSum += pCurrent->Blocks[1][i];
			}
			pCurrent->Blocks[1][127] = ~(ChkSum - 1);
		}
	
}



